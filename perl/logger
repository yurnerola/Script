#!/usr/bin/perl

#Copyleft (C) Yurnerola

use LWP;
use strict;
use warnings;
use Getopt::Std;

use vars qw($opt_h $opt_i);

logger("logger @ARGV\n");

getopts('hi:') or die usage();

die usage() if $opt_h;
die usage() if !$opt_i;

print "---Content Generated By Logger---\n";

my $browser=LWP::UserAgent->new();
my $response=$browser->get("http://dbproxy.show.sina.com.cn:18010/fcgi_bin/get_hall_info.fcgi?id=$opt_i");
#print $response->content;
if ($response->content  =~ /hall_property=(\d+)\n/)
{
	#print "Room is locked\n" if ($1&0x02);
}

my $gas_ip=pinfo($response->content,"gas_ip");
my $gas_id=pinfo($response->content,"gas_id");
my $hall_pwd=pinfo($response->content,"hall_pwd");
my $hall_property=pinfo($response->content,"hall_property");
my $hall_property2=pinfo($response->content,"hall_property2");


print "房间号:$opt_i\n";
print "CRS所在服务器IP: $gas_ip ;gas_id: $gas_id \n";


print "房间类型为：好声音\n" if $hall_property2&0x00000040;
print "房间类型为：开心果\n" if $hall_property2&0x00000080;
print "房间类型为：网舞\n"   if $hall_property2&0x00000100;
print "房间类型为：同城\n"   if $hall_property2&0x00000200;

if ($hall_property&0x00000001)
{
	print "是否支持锁:是\n";  
}
else
{
	print "是否支持锁:否\n"; 
}

if($hall_property&0x00000002)
{
	print "当前锁状态:已锁;密码为:$hall_pwd\n";
}
else
{
	print "当前锁状态:未锁\n";
}

#print "是否支持自动锁:是\n";


print "-----Shell-----\n";
my $shell=<<EOF;
#!/bin/bash
cd /data0/ChatServer$gas_id/UCChatHall_log;
for i in `ls -t|grep $opt_i`;do echo \$i;cat \$i|grep use_prop|grep 100000172;done
EOF
print $shell;

open my $fshell,">","logger.sh";
print $fshell $shell;
close $fshell or die "$fshell:$!";

sub usage {
	return<<'_EOC_';
Usage:
	logger [options]

Options:
	-h              Print this usage.
	-i <hallid>
Example:
	logger -i 447283
_EOC_
}

sub pinfo
{
	if($_[0] =~ /$_[1]=(.*)\n/)
	{
		return $1;
	}
}

sub logger
{
	my $logmsg=shift;
	open my $log,">>","logger.log";
	print $log $logmsg;
	close $log or die "$log:$!";
}
